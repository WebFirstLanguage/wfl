name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Check formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy-and-test:
    name: Build, Test, Clippy
    runs-on: ubuntu-latest
    needs: fmt
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      # Cache Cargo registry and target directory for faster builds
      - name: Cache Cargo registry and target directory
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-build-cache

      # Build debug version first (for development workflow compatibility)
      - name: Build (Debug)
        run: cargo build --verbose

      # Build release version (required for integration tests)
      - name: Build (Release)
        run: cargo build --release --verbose

      # Run tests (integration tests now have access to release binary)
      - name: Run Tests
        run: cargo test --verbose

      # Run Clippy for code quality
      - name: Run Clippy
        run: cargo clippy --all-targets -- -D warnings

  # Cross-platform integration test verification
  integration-tests:
    name: Integration Tests
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    needs: fmt
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      # Cache Cargo registry and target directory for faster builds
      - name: Cache Cargo registry and target directory
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: integration-${{ matrix.os }}

      # Build release version (required for integration tests)
      - name: Build Release Binary
        run: cargo build --release --verbose

      # Verify release binary exists (platform-specific paths)
      - name: Verify Release Binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          if [ ! -f "target/release/wfl" ]; then
            echo "::error::Release binary not found at target/release/wfl"
            exit 1
          fi
          echo "✓ Release binary found: target/release/wfl"

      - name: Verify Release Binary (Windows)
        if: runner.os == 'Windows'
        run: |
          if (!(Test-Path "target/release/wfl.exe")) {
            Write-Host "::error::Release binary not found at target/release/wfl.exe"
            exit 1
          }
          Write-Host "✓ Release binary found: target/release/wfl.exe"

      # Run integration tests specifically
      - name: Run Integration Tests
        run: cargo test --test split_functionality --verbose

      # Run all integration tests to ensure comprehensive coverage
      - name: Run All Integration Tests
        run: cargo test --test '*' --verbose

  # Version bumping only happens after ALL checks pass
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    needs: [fmt, clippy-and-test, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Bump version
        run: python scripts/bump_version.py --update-all

      - name: Push changes
        if: success()
        run: |
          git push origin HEAD:${{ github.ref_name }}

      - name: Tag the new version
        if: success()
        run: |
          # Fetch existing tags to avoid conflicts
          git fetch --tags

          # Extract version from version.rs
          VERSION=$(grep -oP '(?<=VERSION: &str = ")[0-9]+\.[0-9]+\.[0-9]+' src/version.rs)

          # Check if this version tag already exists
          if ! git tag -l | grep -q "^v$VERSION$"; then
            git tag -a "v$VERSION" -m "Release $VERSION"
            git push origin --tags
          else
            echo "Tag v$VERSION already exists, skipping tagging"
          fi
