// Test MVC Components
display "=== MVC Components Test ==="
display ""

// Load MVC components
display "Loading MVC components..."
load module from "../mvc/model.wfl"
load module from "../mvc/view.wfl"
load module from "../mvc/controller.wfl"
display "✓ MVC components loaded"
display ""

// Test 1: Model Creation and Validation
display "Test 1: Model Creation and Validation"
create new UserModel as user:
    model_name is "User"
    is_valid is yes
    errors_list is create list
    user_name is ""
    email is ""
    age is 0
end

user.init_model()
display "✓ User model created"
display ""

// Test 2: Model Validation - Invalid Data
display "Test 2: Model Validation (Invalid)"
user.set_name("Al")  // Too short
user.set_email("alice")  // No @
user.set_age(-5)  // Negative

store valid as user.validate()
display "Is valid: " with valid
display "Errors: " with length of user.get_errors()
display "✓ Validation caught errors"
display ""

// Test 3: Model Validation - Valid Data
display "Test 3: Model Validation (Valid)"
user.set_name("Alice")
user.set_email("alice@example.com")
user.set_age(30)

store valid2 as user.validate()
display "Is valid: " with valid2
display "Errors: " with length of user.get_errors()
display "✓ Validation passed"
display ""

// Test 4: Model to JSON
display "Test 4: Model to JSON"
store user_json as user.to_json()
display "JSON: " with user_json
display "✓ Model serialized to JSON"
display ""

// Test 5: HTML View
display "Test 5: HTML View Rendering"
create new HtmlView as home_view:
    view_name is "Home"
    template_text is ""
    page_title is "Welcome"
    page_content is "<h1>Hello World</h1>"
end

home_view.init_view()
home_view.set_title("WFL MVC Framework")
home_view.set_content("<h1>Welcome!</h1><p>Built with WFL</p>")

store rendered_html as home_view.render()
display "Rendered length: " with length of rendered_html with " characters"
display "✓ HTML view rendered"
display ""

// Test 6: JSON View
display "Test 6: JSON View Rendering"
create new JsonView as api_view:
    view_name is "API"
    json_data is create list
end

api_view.init_view()

store api_data as create list
push with api_data and 1
push with api_data and 2
push with api_data and 3

api_view.set_data(api_data)
store rendered_json as api_view.render()
display "JSON: " with rendered_json
display "✓ JSON view rendered"
display ""

// Test 7: Controller Actions
display "Test 7: Controller Actions"

// Create mock request/response
create container MockRequest:
    property method_val: Text
    property path_val: Text
end

create container MockResponse:
    property content_val: Text
    property status_code: Number

    action set_cont needs new_content: Text:
        store content_val as new_content
    end

    action set_stat needs code: Number:
        store status_code as code
    end
end

create new MockRequest as test_req:
    method_val is "GET"
    path_val is "/api/users"
end

create new MockResponse as test_res:
    content_val is ""
    status_code is 200
end

create new UserController as user_ctrl:
    controller_name is "UserController"
end

user_ctrl.init_controller()
user_ctrl.index_action(test_req, test_res)

display "Response status: " with test_res.status_code
display "Response length: " with length of test_res.content_val with " characters"
display "✓ Controller action executed"
display ""

// Test 8: Home Controller
display "Test 8: Home Controller"
create new HomeController as home_ctrl:
    controller_name is "HomeController"
end

create new MockResponse as test_res2:
    content_val is ""
    status_code is 200
end

home_ctrl.init_controller()
home_ctrl.index_action(test_req, test_res2)

display "Home response status: " with test_res2.status_code
display "Home response length: " with length of test_res2.content_val with " characters"
display "✓ Home controller executed"
display ""

display "=== All MVC Tests Passed! ==="
display ""
display "MVC Components:"
display "  ✓ Models with validation (UserModel)"
display "  ✓ Views with rendering (HtmlView, JsonView)"
display "  ✓ Controllers with actions (UserController, HomeController)"
display "  ✓ Model validation errors tracked (property mutation!)"
display "  ✓ Full MVC pattern implemented in WFL!"
