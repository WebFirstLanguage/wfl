// Test WFL MVC Framework - Middleware System
display "=== WFL MVC Framework - Middleware Test ==="
display ""

// Load middleware components
display "Loading middleware system..."
load module from "../core/middleware.wfl"
load module from "../middleware/cors.wfl"
load module from "../middleware/logging.wfl"
load module from "../middleware/error_handler.wfl"
display "✓ Middleware components loaded"
display ""

// Create mock Request
display "Creating mock request..."
create container MockRequest:
    property method_val: Text
    property path_val: Text
    property body_val: Text
    property client_ip_val: Text
end

create new MockRequest as test_req:
    method_val is "GET"
    path_val is "/api/users/123"
    body_val is ""
    client_ip_val is "127.0.0.1"
end
display "✓ Mock request created"
display ""

// Create mock Response
display "Creating mock response..."
create container MockResponse:
    property content_val: Text
    property status_code: Number
    property content_type_val: Text

    action set_stat needs code: Number:
        store status_code as code
    end

    action set_cont needs content_text: Text:
        store content_val as content_text
    end
end

create new MockResponse as test_res:
    content_val is ""
    status_code is 200
    content_type_val is "text/html"
end
display "✓ Mock response created"
display ""

// Test 1: Create CORS Middleware
display "Test 1: CORS Middleware"
create new CorsMiddleware as cors:
    middleware_name is "CORS"
    enabled is yes
    allowed_origins is "*"
    allowed_methods is "GET,POST,PUT,DELETE"
    allowed_headers is "Content-Type,Authorization"
    max_age is 3600
end

display "✓ CORS middleware created"
cors.handle(test_req, test_res)
display ""

// Test 2: Create Logging Middleware
display "Test 2: Logging Middleware"
create new LoggingMiddleware as logger:
    middleware_name is "Logger"
    enabled is yes
    log_file is "logs/access.log"
    log_format is "combined"
    request_count is 0
end

display "✓ Logging middleware created"
logger.handle(test_req, test_res)
logger.handle(test_req, test_res)
logger.handle(test_req, test_res)
display "Total requests logged: " with logger.request_count
display ""

// Test 3: Create Error Handler Middleware
display "Test 3: Error Handler Middleware"
create new ErrorHandlerMiddleware as error_handler:
    middleware_name is "ErrorHandler"
    enabled is yes
    error_count is 0
    show_stack_trace is no
end

display "✓ Error handler middleware created"
error_handler.handle(test_req, test_res)
display ""

// Test 4: Middleware Chain Execution
display "Test 4: Middleware Chain"
store middleware_chain as create list
push with middleware_chain and cors
push with middleware_chain and logger
push with middleware_chain and error_handler

display "Created middleware chain with " with length of middleware_chain with " middleware"

call execute_middleware_chain with middleware_chain and test_req and test_res
display "✓ Chain executed successfully"
display ""

// Test 5: Simulate error handling
display "Test 5: Error Handling"
error_handler.handle_error("Test error message", test_req, test_res)
error_handler.handle_error("Another error", test_req, test_res)
display "Total errors handled: " with error_handler.error_count
display "Response status after error: " with test_res.status_code
display ""

// Test 6: Configure CORS
display "Test 6: Configure CORS"
cors.configure("https://myapp.com", "GET,POST", "Content-Type")
cors.handle(test_req, test_res)
display ""

display "=== All Middleware Tests Passed! ==="
