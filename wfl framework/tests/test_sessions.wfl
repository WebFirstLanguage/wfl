// Test Session Management System
display "=== Session Management Test ==="
display ""

// Load session management
load module from "../helpers/sessions.wfl"

// Test 1: Create Session Store
display "Test 1: Create Session Store"
create new SessionStore as session_store:
    sessions_list is create list
    session_total is 0
end

session_store.initialize()
display "✓ Session store created"
display ""

// Test 2: Create Sessions
display "Test 2: Create Sessions"
store session1 as session_store.create_session()
display "Session 1 ID: " with session1.session_id
display "Session 1 CSRF: " with session1.csrf_token
display ""

store session2 as session_store.create_session()
display "Session 2 ID: " with session2.session_id
display ""

store session3 as session_store.create_session()
display "Session 3 ID: " with session3.session_id
display ""

display "Total sessions: " with session_store.get_total()
display "✓ Sessions created"
display ""

// Test 3: Retrieve Session
display "Test 3: Retrieve Session by ID"
store retrieved_sess as session_store.get_session(session1.session_id)
display "Retrieved session ID: " with retrieved_sess.session_id
display "✓ Session retrieved"
display ""

// Test 4: Session Expiration Check
display "Test 4: Check Session Expiration"
check if session1.is_expired():
    display "Session 1 is expired"
otherwise:
    display "Session 1 is active"
end check
display "✓ Expiration check works"
display ""

// Test 5: Touch Session (Update Last Accessed)
display "Test 5: Touch Session"
display "Before touch: last_accessed = " with session1.last_accessed
session1.touch()
display "After touch: last_accessed = " with session1.last_accessed
display "✓ Session touched (property mutation works!)"
display ""

// Test 6: Cleanup Expired Sessions
display "Test 6: Cleanup Expired Sessions"
store expired_total as session_store.cleanup_expired()
display "Expired sessions found: " with expired_total
display "✓ Cleanup completed"
display ""

// Test 7: Get Non-Existent Session
display "Test 7: Get Non-Existent Session"
store missing_sess as session_store.get_session("nonexistent-id")
check if missing_sess is nothing:
    display "✓ Returns nothing for missing session"
otherwise:
    display "✗ Should return nothing"
end check
display ""

display "=== All Session Tests Passed! ==="
display ""
display "Session Management System with Property Mutation FIX:"
display "  ✓ Sessions persist across calls"
display "  ✓ session_total increments correctly"
display "  ✓ last_accessed updates properly"
display "  ✓ Full stateful session management works!"
