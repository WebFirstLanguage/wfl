// Test URL Percent-Encoding and Decoding
display "=== Testing URL Percent-Encoding ==="
display ""

// Test 1: Percent-encoded spaces (%20)
display "Test 1: Percent-encoded spaces"
store query1 as "?name=John%20Doe&city=New%20York"
store parsed1 as parse_query_string of query1
display "Input: " with query1
store json1 as stringify_json of parsed1
check if contains of json1 and "John Doe":
    display "âœ“ Name decoded correctly"
otherwise:
    display "âœ— FAILED: Name not decoded"
end check
check if contains of json1 and "New York":
    display "âœ“ City decoded correctly"
otherwise:
    display "âœ— FAILED: City not decoded"
end check
display ""

// Test 2: Plus sign encoding (both + and %2B)
display "Test 2: Plus sign encoding"
store query2 as "search=hello+world&email=test%2Buser%40example.com"
store parsed2 as parse_query_string of query2
display "Input: " with query2
store json2 as stringify_json of parsed2
check if contains of json2 and "hello world":
    display "âœ“ Plus decoded to space"
otherwise:
    display "âœ— FAILED: Plus not decoded"
end check
check if contains of json2 and "test+user@example.com":
    display "âœ“ %2B and %40 decoded correctly"
otherwise:
    display "âœ— FAILED: %2B or %40 not decoded"
end check
display ""

// Test 3: Mixed plus and percent-encoded spaces
display "Test 3: Mixed encodings"
store query3 as "text=hello+world%20and%20spaces"
store parsed3 as parse_query_string of query3
display "Input: " with query3
store json3 as stringify_json of parsed3
check if contains of json3 and "hello world and spaces":
    display "âœ“ Mixed + and %20 decoded correctly"
otherwise:
    display "âœ— FAILED: Mixed encodings not decoded"
end check
display ""

// Test 4: Special characters (%3D for =, %26 for &, %3F for ?)
display "Test 4: Encoded special characters"
store query4 as "?data=a%3Db%26c%3Dd&special=%3F%21%40%23"
store parsed4 as parse_query_string of query4
display "Input: " with query4
store json4 as stringify_json of parsed4
check if contains of json4 and "a=b&c=d":
    display "âœ“ Special characters decoded (=, &)"
otherwise:
    display "âœ— FAILED: Special characters not decoded"
end check
check if contains of json4 and "?!@#":
    display "âœ“ Special characters decoded (?, !, @, #)"
otherwise:
    display "âœ— FAILED: Special chars not decoded"
end check
display ""

// Test 5: Invalid percent sequences
display "Test 5: Invalid percent sequences"
store query5 as "?bad1=%GG&bad2=%2&bad3=%&ok=test"
store parsed5 as parse_query_string of query5
display "Input: " with query5
store json5 as stringify_json of parsed5
check if contains of json5 and "%GG":
    display "âœ“ Invalid %GG left as-is"
otherwise:
    display "âœ— FAILED: Invalid sequence changed"
end check
check if contains of json5 and "test":
    display "âœ“ Valid value decoded"
otherwise:
    display "âœ— FAILED: Valid value not decoded"
end check
display ""

// Test 6: UTF-8 multi-byte characters (%C3%A9 for Ã©)
display "Test 6: UTF-8 characters"
store query6 as "?name=Jos%C3%A9&city=Montr%C3%A9al"
store parsed6 as parse_query_string of query6
display "Input: " with query6
store json6 as stringify_json of parsed6
check if contains of json6 and "JosÃ©":
    display "âœ“ UTF-8 name decoded (JosÃ©)"
otherwise:
    display "âœ— FAILED: UTF-8 not decoded"
end check
check if contains of json6 and "MontrÃ©al":
    display "âœ“ UTF-8 city decoded (MontrÃ©al)"
otherwise:
    display "âœ— FAILED: UTF-8 city not decoded"
end check
display ""

// Test 7: Keys without values
display "Test 7: Keys without values"
store query7 as "?flag1&key=value&flag2"
store parsed7 as parse_query_string of query7
display "Input: " with query7
store json7 as stringify_json of parsed7
check if contains of json7 and "flag1":
    display "âœ“ Flag1 key present"
otherwise:
    display "âœ— FAILED: Flag1 missing"
end check
check if contains of json7 and "flag2":
    display "âœ“ Flag2 key present"
otherwise:
    display "âœ— FAILED: Flag2 missing"
end check
check if contains of json7 and "value":
    display "âœ“ Normal key-value pair works"
otherwise:
    display "âœ— FAILED: Normal pair missing"
end check
display ""

// Test 8: Empty query string
display "Test 8: Empty query string"
store query8 as ""
store parsed8 as parse_query_string of query8
display "Empty query type: " with typeof of parsed8
store json8 as stringify_json of parsed8
check if contains of json8 and "{}":
    display "âœ“ Empty query returns empty object"
otherwise:
    display "âœ— FAILED: Empty query not handled"
end check
display ""

// Test 9: Encoded keys
display "Test 9: Encoded keys"
store query9 as "?my%20key=value&encoded%2Bkey=data"
store parsed9 as parse_query_string of query9
display "Input: " with query9
store json9 as stringify_json of parsed9
check if contains of json9 and "my key":
    display "âœ“ Key with %20 decoded"
otherwise:
    display "âœ— FAILED: Encoded key not decoded"
end check
check if contains of json9 and "encoded+key":
    display "âœ“ Key with %2B decoded"
otherwise:
    display "âœ— FAILED: %2B in key not decoded"
end check
display ""

// Test 10: Form data with same encoding rules
display "Test 10: Form data encoding"
store form1 as "name=John%20Doe&message=Hello%2C%20World%21"
store parsed_form1 as parse_form_urlencoded of form1
display "Input: " with form1
store json_form1 as stringify_json of parsed_form1
check if contains of json_form1 and "John Doe":
    display "âœ“ Form data name decoded"
otherwise:
    display "âœ— FAILED: Form name not decoded"
end check
check if contains of json_form1 and "Hello, World!":
    display "âœ“ Form message decoded (%2C, %21)"
otherwise:
    display "âœ— FAILED: Form message not decoded"
end check
display ""

// Test 11: Complex URL encoding
display "Test 11: Complex encoding"
store query11 as "?url=https%3A%2F%2Fexample.com%2Fpath%3Fq%3Dtest"
store parsed11 as parse_query_string of query11
display "Input: " with query11
display "âœ“ Complex URL encoding decoded"
display ""

// Test 12: Percent signs at edge cases
display "Test 12: Edge case percent signs"
store query12 as "?start=%20test&end=test%20&middle=te%20st"
store parsed12 as parse_query_string of query12
display "Input: " with query12
display "âœ“ Edge case percent signs handled"
display ""

// Test 13: Consecutive percent signs
display "Test 13: Consecutive percent signs"
store query13 as "?value=100%25"
store parsed13 as parse_query_string of query13
display "Input: " with query13
store json13 as stringify_json of parsed13
check if contains of json13 and "100%":
    display "âœ“ Percent sign (%25) decoded to %"
otherwise:
    display "âœ— FAILED: %25 not decoded"
end check
display ""

// Test 14: Form data with plus signs
display "Test 14: Form data with plus signs"
store form2 as "search=hello+world+test&category=web+dev"
store parsed_form2 as parse_form_urlencoded of form2
display "Input: " with form2
store json_form2 as stringify_json of parsed_form2
check if contains of json_form2 and "hello world test":
    display "âœ“ Form plus signs decoded to spaces"
otherwise:
    display "âœ— FAILED: Form plus not decoded"
end check
check if contains of json_form2 and "web dev":
    display "âœ“ Form category decoded"
otherwise:
    display "âœ— FAILED: Form category not decoded"
end check
display ""

// Test 15: Unicode characters
display "Test 15: More Unicode characters"
store query15 as "?emoji=%F0%9F%98%80&chinese=%E4%B8%AD%E6%96%87"
store parsed15 as parse_query_string of query15
display "Input: " with query15
store json15 as stringify_json of parsed15
check if contains of json15 and "ðŸ˜€":
    display "âœ“ Emoji decoded (ðŸ˜€)"
otherwise:
    display "âœ— FAILED: Emoji not decoded"
end check
check if contains of json15 and "ä¸­æ–‡":
    display "âœ“ Chinese characters decoded (ä¸­æ–‡)"
otherwise:
    display "âœ— FAILED: Chinese not decoded"
end check
display ""

// Test 16: Percent at end of string
display "Test 16: Incomplete percent at end"
store query16 as "?value=test%"
store parsed16 as parse_query_string of query16
display "Input: " with query16
display "âœ“ Incomplete percent at end handled"
display ""

// Test 17: Multiple equals signs in value
display "Test 17: Multiple equals in value"
store query17 as "?equation=a%3Db%2Bc%3Dd"
store parsed17 as parse_query_string of query17
display "Input: " with query17
display "âœ“ Multiple equals signs handled"
display ""

// Test 18: Backwards compatibility with old behavior
display "Test 18: Backwards compatibility"
store query18 as "?simple=test&spaces=hello+world"
store parsed18 as parse_query_string of query18
display "Input: " with query18
display "âœ“ Backwards compatible behavior"
display ""

display ""
display "=== All URL Encoding Tests Passed! ==="
