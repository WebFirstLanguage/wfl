// Weave Framework - Static Files Example
// Demonstrates serving static files with security and MIME detection

display "=== Weave Static Files Server ==="
display ""

// ===== Configuration =====
store server_port_number as 3005
store static_directory as "../test_public"
store request_counter as 0

// ===== MIME Type Detection =====

define action called string_ends_with with parameters text_string and suffix_string:
    store text_len as length of text_string
    store suffix_len as length of suffix_string

    check if suffix_len is greater than text_len:
        return no
    end check

    store start_pos as text_len minus suffix_len
    store ending as substring of text_string and start_pos and text_len

    check if ending is equal to suffix_string:
        return yes
    otherwise:
        return no
    end check
end action

define action called detect_mime_type with parameters file_path:
    store is_html as call string_ends_with with file_path and ".html"
    check if is_html:
        return "text/html"
    end check

    store is_css as call string_ends_with with file_path and ".css"
    check if is_css:
        return "text/css"
    end check

    store is_js as call string_ends_with with file_path and ".js"
    check if is_js:
        return "application/javascript"
    end check

    store is_json as call string_ends_with with file_path and ".json"
    check if is_json:
        return "application/json"
    end check

    store is_png as call string_ends_with with file_path and ".png"
    check if is_png:
        return "image/png"
    end check

    store is_jpg as call string_ends_with with file_path and ".jpg"
    check if is_jpg:
        return "image/jpeg"
    end check

    return "application/octet-stream"
end action

// ===== Security Functions =====

define action called contains_string with parameters haystack and needle:
    store haystack_len as length of haystack
    store needle_len as length of needle

    check if needle_len is greater than haystack_len:
        return no
    end check

    store max_pos as haystack_len minus needle_len
    add 1 to max_pos

    count from 0 to max_pos:
        store check_end as count plus needle_len
        store substr as substring of haystack and count and check_end

        check if substr is equal to needle:
            return yes
        end check
    end count

    return no
end action

define action called is_safe_path with parameters request_path:
    // Prevent directory traversal
    store has_dotdot as call contains_string with request_path and ".."
    check if has_dotdot:
        return no
    end check

    // Prevent hidden files
    store has_slashdot as call contains_string with request_path and "/."
    check if has_slashdot:
        return no
    end check

    return yes
end action

// ===== Static File Serving =====

define action called try_serve_file with parameters req and static_dir and req_path:

    // Security check
    store path_safe as call is_safe_path with req_path
    check if path_safe is equal to no:
        display "  ğŸš« Security block: " with req_path
        respond to req with "403 Forbidden" and status 403
        return yes
    end check

    // Build full path
    store full_path as static_dir with req_path

    // Try to serve file
    check if file exists at full_path:
        try:
            open file at full_path for reading as static_file
            store file_content as read content from static_file
            close file static_file

            store content_type as call detect_mime_type with full_path

            respond to req with file_content
            display "  âœ… Served: " with req_path with " (" with content_type with ")"

            return yes
        catch:
            display "  âŒ Error reading: " with full_path
            respond to req with "500 Internal Server Error" and status 500
            return yes
        end try
    end check

    return no
end action

// ===== Start Server =====

display "ğŸš€ Starting Static Files Server"
display "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
display "  Port: " with server_port_number
display "  Static directory: " with static_directory
display "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

// Check if static directory exists
check if directory exists at static_directory:
    display "âœ… Static directory found"
otherwise:
    display "âš ï¸  Static directory not found: " with static_directory
    display "   Creating it now..."
    create directory at static_directory
end check

display "âœ… Server started at http://127.0.0.1:" with server_port_number
display "   Try: http://127.0.0.1:" with server_port_number with "/index.html"
display ""

listen on port server_port_number as web_server

// Main request loop
main loop:
    wait for request comes in on web_server as incoming_request
    add 1 to request_counter

    // Log request
    display "ğŸ“¥ [" with request_counter with "] " with method with " " with path with " from " with client_ip

    // Try to serve static file (path is global variable)
    store served as call try_serve_file with incoming_request and static_directory and path

    // If not served, return 404
    check if served is equal to no:
        store not_found_html as "<!DOCTYPE html>
<html>
<head>
    <title>404 - Not Found</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            margin-top: 100px;
            background: #f5f5f5;
        }
        h1 { color: #e74c3c; font-size: 72px; margin: 0; }
        p { color: #555; }
        code { background: #eee; padding: 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>404</h1>
    <p>File not found: <code>" with path with "</code></p>
    <p><a href=\"/\">â† Go back</a></p>
</body>
</html>"
        respond to incoming_request with not_found_html and status 404
        display "  âœ— 404 Not Found"
    end check
end loop
